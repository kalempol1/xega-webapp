<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XEGA TAP — WebApp</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            // Sadece kırmızı & siyah tonları
            xega: {
              50:  '#ffe5e5',
              100: '#ffcaca',
              200: '#ff9b9b',
              300: '#ff6b6b',
              400: '#f94848',
              500: '#e71919', // primary red
              600: '#c51616',
              700: '#991111',
              800: '#6f0b0b',
              900: '#3a0505'
            },
            ink: {
              900: '#0b0b0b',
              800: '#151515',
              700: '#1a1a1a'
            }
          },
          boxShadow: {
            glow: '0 0 120px rgba(231,25,25,.35)'
          },
          keyframes: {
            pulseGlow: {
              '0%, 100%': { transform: 'scale(1)', boxShadow: '0 0 0 rgba(231,25,25,0.0)' },
              '50%': { transform: 'scale(1.02)', boxShadow: '0 0 80px rgba(231,25,25,.35)' }
            }
          },
          animation: {
            pulseGlow: 'pulseGlow 2.4s ease-in-out infinite'
          }
        }
      }
    }
  </script>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* KIRMIZI & SİYAH PALET — açık metin için siyah kullanıyoruz */
    html, body { height: 100%; background: #3a0505; }
    .surface { background: linear-gradient(180deg, #4b0505, #3a0505 40%, #2a0404 100%); }
    .panel   { background: rgba(231,25,25,0.08); border: 1px solid rgba(0,0,0,.6); }
    .chip    { background: rgba(231,25,25,0.13); border: 1px solid rgba(0,0,0,.7); }
    .divider { border-color: rgba(0,0,0,.5); }
    .btn-red { background: linear-gradient(180deg, #e71919, #c51616); border: 2px solid #991111; }
    .btn-red:active { transform: scale(.98); }
    .tab-btn { color: #000; background: rgba(231,25,25,0.16); border: 1px solid rgba(0,0,0,.6); }
    .tab-btn.active { background: linear-gradient(180deg, #e71919, #c51616); border-color: #991111; color: #000; }
    .text-soft { color: #120000; }       /* koyu siyah ton */
    .text-hard { color: #000000; }       /* tam siyah */
    .text-ghost { color: #220000; }      /* hafif kırmızımsı-siyah */
  </style>
</head>

<body class="h-full text-hard">
  <div class="min-h-screen surface flex flex-col">

    <!-- ÜST HERO: Ortada XEGA Logo -->
    <header class="relative">
      <div class="max-w-6xl mx-auto px-4 pt-10 pb-8">
        <div class="flex items-center justify-center">
          <!-- Logo kapsayıcı -->
          <div class="h-44 w-44 rounded-3xl btn-red shadow-glow animate-pulseGlow grid place-items-center select-none">
            <!-- Inline XEGA Logo (SVG) -->
            <svg viewBox="0 0 240 240" class="h-24 w-24">
              <defs>
                <linearGradient id="grad" x1="0" x2="1" y1="0" y2="1">
                  <stop offset="0%"  stop-color="#ff6b6b"/>
                  <stop offset="100%" stop-color="#e71919"/>
                </linearGradient>
              </defs>
              <rect x="8" y="8" width="224" height="224" rx="36" fill="url(#grad)" stroke="#991111" stroke-width="10"/>
              <path d="M60 160 L120 60 L180 160 Z M90 160 L150 160" stroke="#000" stroke-width="14" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </div>

        <!-- Stat çipleri -->
        <div class="mt-8 grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="panel rounded-2xl p-4">
            <div class="text-ghost text-sm">XEGA</div>
            <div id="stat-xega" class="text-2xl font-semibold">0</div>
          </div>
          <div class="panel rounded-2xl p-4">
            <div class="text-ghost text-sm">Energy</div>
            <div class="flex items-end justify-between mt-1">
              <div class="text-2xl font-semibold"><span id="stat-energy">100</span>/100</div>
              <div class="text-ghost text-xs ml-4"><span id="stat-regen">36</span>s / energy</div>
            </div>
            <div class="mt-2 w-full h-2 bg-black/60 rounded-full">
              <div id="energy-bar" class="h-2 bg-black rounded-full" style="width:100%"></div>
            </div>
          </div>
          <div class="panel rounded-2xl p-4">
            <div class="text-ghost text-sm">Multiplier</div>
            <div class="text-2xl font-semibold">x<span id="stat-mult">1.0</span></div>
            <div class="text-ghost text-xs">Lv <span id="lv-mult">0</span></div>
          </div>
          <div class="panel rounded-2xl p-4">
            <div class="text-ghost text-sm">Critical</div>
            <div class="text-2xl font-semibold"><span id="stat-crit">12</span>%</div>
            <div class="text-ghost text-xs">Lv <span id="lv-crit">0</span></div>
          </div>
        </div>
      </div>
    </header>

    <!-- ANA İÇERİK: Sekmelere göre değişen paneller -->
    <main class="flex-1 max-w-6xl mx-auto w-full px-4 pb-28">
      <!-- SHOP -->
      <section id="tab-shop" class="panel rounded-2xl p-6">
        <div class="text-xl font-semibold mb-4">Shop</div>
        <div id="shop" class="space-y-3"></div>
      </section>

      <!-- PROFILE -->
      <section id="tab-profile" class="panel rounded-2xl p-6 hidden">
        <div class="text-xl font-semibold mb-4">Profile</div>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="chip rounded-2xl p-4">
            <div class="text-ghost text-sm mb-1">Display Name <span id="name-lock" class="opacity-70 hidden">(locked)</span></div>
            <div class="flex gap-2">
              <input id="name-input" type="text"
                     class="flex-1 px-3 py-2 rounded-xl bg-black/10 border border-black/70 text-hard placeholder:text-ghost"
                     placeholder="Choose your name (one-time)"/>
              <button id="name-save" class="px-3 py-2 rounded-xl tab-btn">Save</button>
            </div>
          </div>
          <div class="chip rounded-2xl p-4">
            <div class="text-ghost text-sm mb-1">Solana Wallet</div>
            <div class="flex gap-2">
              <input id="wallet-input" type="text"
                     class="flex-1 px-3 py-2 rounded-xl bg-black/10 border border-black/70 text-hard placeholder:text-ghost"
                     placeholder="Paste wallet (e.g., 9zqJ...)"/>
              <button id="wallet-save" class="px-3 py-2 rounded-xl tab-btn">Save</button>
            </div>
            <div class="text-ghost text-xs mt-1">Current: <span id="wallet-current" class="font-medium">—</span></div>
          </div>
        </div>
      </section>

      <!-- LEADERBOARD -->
      <section id="tab-leaderboard" class="panel rounded-2xl p-6 hidden">
        <div class="text-xl font-semibold mb-4">Leaderboard</div>
        <div id="leaders" class="space-y-2"></div>
      </section>

      <!-- REFERRALS -->
      <section id="tab-referrals" class="panel rounded-2xl p-6 hidden">
        <div class="text-xl font-semibold mb-4">Referrals</div>
        <div class="text-ghost text-sm mb-3">People you referred</div>
        <div id="ref-list" class="space-y-2"></div>
      </section>
    </main>

    <!-- ALT TAB BAR -->
    <nav class="fixed bottom-0 inset-x-0">
      <div class="max-w-6xl mx-auto px-4 pb-3">
        <div class="chip rounded-2xl p-2 flex items-center justify-between gap-2 backdrop-blur">
          <button class="tab-btn rounded-xl px-4 py-2 w-full active" data-tab="shop">Shop</button>
          <button class="tab-btn rounded-xl px-4 py-2 w-full" data-tab="profile">Profile</button>
          <button class="tab-btn rounded-xl px-4 py-2 w-full" data-tab="leaderboard">Leaderboard</button>
          <button class="tab-btn rounded-xl px-4 py-2 w-full" data-tab="referrals">Referrals</button>
        </div>
      </div>
    </nav>
  </div>

  <!-- App Logic -->
  <script>
    // === Constants ===
    const ENERGY_MAX = 100;
    const REGEN_BASE_SEC = 36;
    const REGEN_FLOOR_SEC = 10;
    const BASE_TAP = 1;
    const CRIT_BASE = 0.12;
    const CRIT_PER_LEVEL = 0.02;
    const CRIT_CAP = 0.40;
    const MULTI_PER_LEVEL = 0.5;

    const SHOP_DEF = {
      tap_power:  { key: 'tap_power',  name:'Tap Power (+1)', base:500,  m0:1.75, inc:0.02,  max:10 },
      multiplier: { key: 'multiplier', name:'Multiplier',     base:800,  m0:1.60, inc:0.015, max:30 },
      crit:       { key: 'crit',       name:'Critical',       base:600,  m0:1.55, inc:0.015, max:30 },
      regen:      { key: 'regen',      name:'Energy Regen',   base:500,  m0:1.50, inc:0.010, max:30 },
      autotap:    { key: 'autotap',    name:'AutoTap (1 Level)', base:25000, m0:1.0, inc:0.0, max:1 },
    };

    function nextCost(def, nextLevel){
      if (nextLevel <= 0) return 0;
      const factor = def.m0 + def.inc * (nextLevel - 1);
      return Math.max(1, Math.round(def.base * Math.pow(factor, (nextLevel - 1))));
    }
    function regenSecFromLevel(regenLevel){
      const sec = Math.round(REGEN_BASE_SEC * Math.pow(0.90, regenLevel));
      return Math.max(REGEN_FLOOR_SEC, sec);
    }
    function computeTapGain(state){
      const tapPower = (state.tap_power_level || 0);
      const baseGain = BASE_TAP + tapPower;
      const multi = 1 + MULTI_PER_LEVEL * (state.multiplier_level || 0);
      const critChance = Math.min(CRIT_CAP, CRIT_BASE + CRIT_PER_LEVEL * (state.crit_level || 0));
      const isCrit = Math.random() < critChance;
      const gain = Math.max(1, Math.round(baseGain * multi * (isCrit ? 2 : 1)));
      return { gain, isCrit };
    }

    // === State (mock) ===
    const st = {
      display_name: '',
      name_locked: false,
      wallet: '',
      xega: 0,
      energy: ENERGY_MAX,
      tap_power_level: 0,
      multiplier_level: 0,
      crit_level: 0,
      regen_level: 0,
      autotap_owned: false,
      autotap_enabled: false,
      autotap_used_min: 0,
      // Mock referrals (backendten doldurulacak)
      referrals: [
        // { name:'PlayerA', since:'2025-10-01' },
        // { name:'PlayerB', since:'2025-10-03' },
      ]
    };

    // === DOM refs ===
    const el = {
      xega: document.getElementById('stat-xega'),
