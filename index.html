<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XEGA TAP â€” WebApp</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + ReactDOM (UMD) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel (JSX iÃ§in, inline script) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Framer Motion (UMD) -->
  <script src="https://unpkg.com/framer-motion/dist/framer-motion.umd.js"></script>

  <style>
    :root {
      --xega-red: #e60012;
      --deep-red-1: #2a0000;
      --deep-red-2: #190000;
      --deep-red-3: #0d0000;
    }
    html, body { height: 100%; }
  </style>
</head>

<body class="h-full">
  <div id="root" class="h-full"></div>

  <script type="text/babel">
    // ---- SAFE IMPORTS / SHIMS ----
    const React = window.React, ReactDOM = window.ReactDOM;
    // BazÄ± CDN paketleri globali farklÄ± isimle verebiliyor; gÃ¼venli yakala:
    const FM_GLOBAL = window.framerMotion || window["framer-motion"] || {};
    // Åžayet framer-motion gelmezse, motion ve AnimatePresence iÃ§in ÅŸÄ±k "no-op" ÅŸemasÄ±:
    const motion = FM_GLOBAL.motion || new Proxy({}, {
      get: (_, tag) => (props) => React.createElement(tag || 'div', props, props.children)
    });
    const AnimatePresence = FM_GLOBAL.AnimatePresence || (({ children }) => children);

    const { useState, useEffect, useMemo } = React;

    // ---- THEME / CONSTS ----
    const BG_GRADIENT = "bg-gradient-to-b from-[var(--deep-red-1)] via-[var(--deep-red-2)] to-[var(--deep-red-3)]";
    const CARD_BG = "bg-[#170000]/70 border border-[#330000]";
    const R_TEXT = "text-[#ff2a2a]";

    const ENERGY_MAX = 100;
    const MULTI_PER_LEVEL = 0.5;
    const CRIT_BASE = 0.12;
    const CRIT_PER_LEVEL = 0.02;
    const CRIT_CAP = 0.40;

    const clamp = (n,a,b)=>Math.min(b,Math.max(a,n));
    const format = (n)=> new Intl.NumberFormat().format(n);

    function mkBurst(n=16){
      return Array.from({length:n}).map((_,i)=>({
        id: Math.random().toString(36).slice(2,9)+i,
        angle: Math.random()*Math.PI*2,
        dist: 40 + Math.random()*80,
        scale: 0.7 + Math.random()*0.6,
        delay: Math.random()*0.02,
        rot: (Math.random()*60-30),
      }));
    }

    function App(){
      const [xega,setXega]=useState(0);
      const [energy,setEnergy]=useState(ENERGY_MAX);
      const [multiplier_level,setMult]=useState(0);
      const [crit_level,setCrit]=useState(0);

      const [displayName,setDisplayName]=useState("Player");
      const [nameLocked,setNameLocked]=useState(false);
      const [wallet,setWallet]=useState("");
      const [tab,setTab]=useState("shop");

      const [burst,setBurst]=useState([]);
      const [pulse,setPulse]=useState([]);

      function triggerPulse(){
        const id=Math.random().toString(36).slice(2,9);
        setPulse([{id}]);
        setTimeout(()=>setPulse([]),1200);
      }

      function onTap(){
        if(energy<=0)return;
        const mult=1+MULTI_PER_LEVEL*multiplier_level;
        const critChance=Math.min(CRIT_CAP,CRIT_BASE+CRIT_PER_LEVEL*crit_level);
        const isCrit=Math.random()<critChance;
        const gain=Math.max(1,Math.round(1*mult*(isCrit?2:1)));
        setXega(v=>v+gain);
        setEnergy(e=>clamp(e-1,0,ENERGY_MAX));
        setBurst(mkBurst(18));
        triggerPulse();
        try { window.Telegram?.WebApp?.HapticFeedback?.impactOccurred('light'); } catch {}
      }

      useEffect(()=>{
        const id=setInterval(()=>setEnergy(e=>e<ENERGY_MAX?e+1:e),1500);
        return()=>clearInterval(id);
      },[]);

      const multX=useMemo(()=> (1+MULTI_PER_LEVEL*multiplier_level).toFixed(1),[multiplier_level]);
      const critPct=useMemo(()=> Math.round(Math.min(CRIT_CAP,CRIT_BASE+CRIT_PER_LEVEL*crit_level)*100),[crit_level]);

      return (
        <div className={`min-h-screen ${BG_GRADIENT} text-zinc-200 flex flex-col`}>
          {/* Top HUD */}
          <header className="w-full px-4 pt-4">
            <div className="max-w-5xl mx-auto flex items-center justify-between">
              <div className="flex items-center gap-3 text-xs">
                <div className={`px-2 py-1 rounded-md ${CARD_BG}`}>
                  <span className="text-zinc-400">Crit</span> <span className="font-semibold">{critPct}%</span>
                </div>
                <div className={`px-2 py-1 rounded-md ${CARD_BG}`}>
                  <span className="text-zinc-400">Mult</span> <span className="font-semibold">x{multX}</span>
                </div>
              </div>
              <div className={`px-2 py-2 rounded-xl ${CARD_BG} w-56`}>
                <div className="flex items-center justify-between text-[10px] text-zinc-300 mb-1">
                  <span>Energy</span>
                  <span className="text-zinc-400">{energy}/{ENERGY_MAX}</span>
                </div>
                <div className="h-2 w-full bg-black/40 rounded-full overflow-hidden">
                  <div className="h-full" style={{background:'var(--xega-red)',width:`${(energy/ENERGY_MAX)*100}%`}}></div>
                </div>
              </div>
            </div>
          </header>

          {/* Main */}
          <main className="flex-1 relative flex items-center justify-center">
            <div className="absolute inset-0 -z-10 pointer-events-none">
              <div className="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent"></div>
              <div className="absolute left-1/2 top-[42%] -translate-x-1/2 -translate-y-1/2 w-[520px] h-[520px] rounded-full opacity-30 blur-3xl"
                   style={{background:'radial-gradient(closest-side, var(--xega-red), transparent 70%)'}}></div>
            </div>

            <div className="flex flex-col items-center justify-center">
              <div className={`mb-6 px-4 py-1.5 rounded-full ${CARD_BG} text-sm`}>
                <span className="mr-2">XEGA</span> <span className={R_TEXT}>{format(xega)}</span>
              </div>

              <motion.button
                whileTap={{ scale: 0.93 }}
                onClick={onTap}
                className="relative h-44 w-44 md:h-56 md:w-56 rounded-3xl border border-[#3b0000] bg-[#120000] shadow-[0_0_160px_-30px_rgba(230,0,18,0.6)] flex items-center justify-center overflow-hidden select-none"
                aria-label="Tap"
              >
                <img src="/xega-logo.svg" alt="XEGA" className="h-24 w-24" />

                {/* Energy Pulse */}
                <AnimatePresence>
                  {pulse.map(p=>(
                    <motion.div key={p.id}
                      initial={{opacity:0.4,scale:0.3}}
                      animate={{opacity:0,scale:3}}
                      exit={{opacity:0}}
                      transition={{duration:1.2,ease:'easeOut'}}
                      className="absolute inset-0 rounded-full"
                      style={{
                        border:'3px solid rgba(255,0,0,0.4)',
                        boxShadow:'0 0 50px rgba(255,0,0,0.3)',
                      }}
                    />
                  ))}
                </AnimatePresence>

                {/* Coin burst */}
                <AnimatePresence initial={false}>
                  {burst.map(p=>(
                    <motion.div key={p.id}
                      initial={{opacity:0.9,x:0,y:0,scale:p.scale}}
                      animate={{opacity:0,x:Math.cos(p.angle)*p.dist,y:Math.sin(p.angle)*p.dist,rotate:p.rot}}
                      transition={{duration:0.9,delay:p.delay,ease:'easeOut'}}
                      className="absolute pointer-events-none"
                    >
                      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" fill="#ffd166"/>
                        <circle cx="12" cy="12" r="7" fill="#ffcc33"/>
                        <text x="12" y="13.5" text-anchor="middle" font-size="8" font-weight="700" fill="#8d4a00">Îž</text>
                      </svg>
                    </motion.div>
                  ))}
                </AnimatePresence>
              </motion.button>
            </div>
          </main>

          {/* Bottom Tabs */}
          <footer className="w-full border-t border-[#330000] bg-[#120000]/90 backdrop-blur">
            <div className="max-w-5xl mx-auto">
              <div className="grid grid-cols-4 text-center">
                <Tab icon="ðŸ›’" label="Shop" active={tab==='shop'} onClick={()=>setTab('shop')} />
                <Tab icon="ðŸ‘¤" label="Profile" active={tab==='profile'} onClick={()=>setTab('profile')} />
                <Tab icon="ðŸ‘‘" label="Leaderboard" active={tab==='leader'} onClick={()=>setTab('leader')} />
                <Tab icon="ðŸ”—" label="Referrals" active={tab==='ref'} onClick={()=>setTab('ref')} />
              </div>
            </div>
          </footer>
        </div>
      );
    }

    function Tab({icon,label,active,onClick}){
      return (
        <button onClick={onClick} className={`py-2 flex flex-col items-center ${active?'text-[#ff2a2a]':'text-zinc-400'}`}>
          <span className="text-lg">{icon}</span>
          <span className="text-[11px]">{label}</span>
        </button>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>
